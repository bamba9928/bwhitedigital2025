<!DOCTYPE html>
{% load widget_tweaks %}
{% load static %}
{% load humanize %}
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <title>Informations V√©hicule</title>
        <script src="https://unpkg.com/htmx.org@1.9.10"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
              rel="stylesheet">
        <!-- HTMX + JS MAGIQUE -->
        <script>
        // 1. Affiche/cache le wrapper apr√®s chaque swap HTMX
        document.body.addEventListener('htmx:afterSwap', evt => {
            if (evt.detail.target.id !== 'sous-categorie-wrapper') return;
            const wrapper = evt.detail.target;
            const hasContent = wrapper.innerHTML.trim() !== '';
            wrapper.classList.toggle('hidden', !hasContent);

            console.log('üîÑ HTMX swap:', hasContent ? 'Contenu re√ßu' : 'Vide');
        });

        // 2. Vide compl√®tement le wrapper avant chaque requ√™te
        document.body.addEventListener('htmx:beforeRequest', evt => {
            if (evt.detail.elt.id === 'id_categorie') {
                const wrapper = document.getElementById('sous-categorie-wrapper');
                if (wrapper) {
                    wrapper.innerHTML = '';
                    wrapper.classList.add('hidden');
                    console.log('üßπ Wrapper vid√© avant requ√™te');
                }
            }
        });

        // 3. Charge automatiquement les sous-cat√©gories en mode √©dition
        document.addEventListener('DOMContentLoaded', () => {
            const cat = document.getElementById('id_categorie');
            if (cat && cat.value && ['520', '550'].includes(cat.value)) {
                console.log('üìã Chargement initial pour cat√©gorie:', cat.value);
                htmx.trigger(cat, 'change');
            }
        });

        // 4. Nettoie le wrapper quand on s√©lectionne une cat√©gorie sans sous-cat√©gories
        document.body.addEventListener('htmx:afterRequest', evt => {
            if (evt.detail.elt.id === 'id_categorie') {
                const wrapper = document.getElementById('sous-categorie-wrapper');
                const response = evt.detail.xhr.responseText.trim();

                if (!response || response === '') {
                    wrapper.innerHTML = '';
                    wrapper.classList.add('hidden');
                    console.log('üîí Wrapper cach√© (pas de sous-cat√©gories)');
                }
            }
        });

        // 5. Debug - Logs d√©taill√©s
        document.body.addEventListener('htmx:beforeRequest', evt => {
            if (evt.detail.elt.id === 'id_categorie') {
                const categorieId = evt.detail.elt.value;
                console.log('üì§ Requ√™te pour cat√©gorie:', categorieId);
            }
        });

        document.body.addEventListener('htmx:afterRequest', evt => {
            if (evt.detail.elt.id === 'id_categorie') {
                const status = evt.detail.xhr.status;
                const preview = evt.detail.xhr.responseText.substring(0, 100);
                console.log(`üì• R√©ponse ${status}:`, preview);
            }
        });

        document.body.addEventListener('htmx:responseError', evt => {
            console.error('‚ùå Erreur HTMX:', evt.detail.xhr.status, evt.detail.xhr.statusText);
        });
        </script>
        <!-- STYLE -->
        <style>
        #sous-categorie-wrapper.hidden {
            display: none !important;
        }
        .htmx-indicator {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .htmx-request .htmx-indicator {
            opacity: 1;
        }
        .htmx-request {
            opacity: 0.8;
        }
        </style>
    </head>
    <body class="bg-gray-950 text-white">
        <div class="form-section max-w-7xl mx-auto p-6">
            <h2 class="text-2xl font-semibold mb-6 flex items-center">
                <i class="fas fa-car mr-3 text-green-400"></i> Informations V√©hicule
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="field-group">
                    <label for="{{ vehicule_form.immatriculation.id_for_label }}"
                           class="block text-gray-300 text-sm font-medium mb-2">
                        <i class="fas fa-id-card mr-1 text-green-500"></i> Immatriculation <span class="text-red-400">*</span>
                    </label>
                    {{ vehicule_form.immatriculation|attr:"required:required" }}
                    <div id="immat-error"></div>
                </div>
                <div class="field-group">
                    <label for="{{ vehicule_form.marque.id_for_label }}"
                           class="block text-gray-300 text-sm font-medium mb-2">
                        <i class="fas fa-tag mr-1 text-green-500"></i> Marque <span class="text-red-400">*</span>
                    </label>
                    {{ vehicule_form.marque|attr:"required:required" }}
                    {% if vehicule_form.marque.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ vehicule_form.marque.errors.0 }}</p>
                    {% endif %}
                </div>
                <div class="field-group">
                    <label for="{{ vehicule_form.modele.id_for_label }}"
                           class="block text-gray-300 text-sm font-medium mb-2">
                        <i class="fas fa-car-side mr-1 text-green-500"></i> Mod√®le <span class="text-red-400">*</span>
                    </label>
                    {{ vehicule_form.modele|attr:"required:required" }}
                    {% if vehicule_form.modele.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ vehicule_form.modele.errors.0 }}</p>
                    {% endif %}
                </div>
                <div class="field-group">
                    <label for="{{ vehicule_form.categorie.id_for_label }}"
                           class="block text-gray-300 text-sm font-medium mb-2">
                        <i class="fas fa-layer-group mr-1 text-green-500"></i> Cat√©gorie <span class="text-red-400">*</span>
                    </label>
                    {{ vehicule_form.categorie|attr:"required:required" }}
                </div>
                <div id="sous-categorie-wrapper"
                     class="hidden field-group md:col-span-2 lg:col-span-1"></div>
                <div class="field-group">
                    <label for="{{ vehicule_form.puissance_fiscale.id_for_label }}"
                           class="block text-gray-300 text-sm font-medium mb-2">
                        <i class="fas fa-tachometer-alt mr-1 text-green-500"></i> Puissance (CV) <span class="text-red-400">*</span>
                    </label>
                    {{ vehicule_form.puissance_fiscale|attr:"required:required" }}
                </div>
                <div class="field-group">
                    <label for="{{ vehicule_form.nombre_places.id_for_label }}"
                           class="block text-gray-300 text-sm font-medium mb-2">
                        <i class="fas fa-users mr-1 text-green-500"></i> Nombre de places <span class="text-red-400">*</span>
                    </label>
                    {{ vehicule_form.nombre_places|attr:"required:required" }}
                </div>
                <div class="field-group">
                    <label for="{{ vehicule_form.carburant.id_for_label }}"
                           class="block text-gray-300 text-sm font-medium mb-2">
                        <i class="fas fa-gas-pump mr-1 text-green-500"></i> Carburant <span class="text-red-400">*</span>
                    </label>
                    {{ vehicule_form.carburant|attr:"required:required" }}
                </div>
                {{ vehicule_form.charge_utile }}
                <div class="hidden">
                    {{ vehicule_form.valeur_neuve }}
                    {{ vehicule_form.valeur_venale }}
                </div>
            </div>
        </div>
    </body>
</html>
