<!DOCTYPE html>
{% load widget_tweaks %}
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Informations Véhicule</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <!-- HTMX + JS MAGIQUE -->
    <script>
        // 1. Cache/monte le wrapper après chaque swap
        document.body.addEventListener('htmx:afterSwap', evt => {
            if (evt.detail.target.id !== 'sous-categorie-wrapper') return;
            const wrapper = evt.detail.target;
            wrapper.classList.toggle('hidden', wrapper.innerHTML.trim() === '');
        });

        // 2. Réinitialise la sous-catégorie avant chaque changement
        document.body.addEventListener('htmx:beforeRequest', evt => {
            if (evt.detail.elt.id === 'id_categorie') {
                const sousCat = document.getElementById('id_sous_categorie');
                if (sousCat) sousCat.value = '';
            }
        });

        // 3. Charge automatiquement en édition
        document.addEventListener('DOMContentLoaded', () => {
            const cat = document.getElementById('id_categorie');
            if (cat && ['520', '550'].includes(cat.value)) {
                htmx.trigger(cat, 'change');
            }
        });
    </script>

    <!-- STYLE -->
    <style>
        #sous-categorie-wrapper.hidden { display: none !important; }
        .htmx-indicator { opacity: 0; transition: opacity 0.2s; }
        .htmx-request .htmx-indicator { opacity: 1; }
        .htmx-request { opacity: 0.8; }
    </style>
</head>
<body class="bg-gray-950 text-white">

<div class="form-section max-w-7xl mx-auto p-6">
    <h2 class="text-2xl font-semibold mb-6 flex items-center">
        <i class="fas fa-car mr-3 text-green-400"></i> Informations Véhicule
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

        <!-- Immatriculation -->
        <div class="field-group">
            <label class="block text-gray-300 text-sm font-medium mb-2">
                <i class="fas fa-id-card mr-1 text-green-500"></i> Immatriculation <span class="text-red-400">*</span>
            </label>
            {% render_field vehicule_form.immatriculation %}
            <div id="immat-error"></div>
            <div id="immat-loading" class="htmx-indicator hidden text-xs text-green-400 mt-1">
                <i class="fas fa-spinner fa-spin mr-1"></i> Vérification...
            </div>
            {% if vehicule_form.immatriculation.errors %}
                <p class="text-red-500 text-xs mt-1">{{ vehicule_form.immatriculation.errors.0 }}</p>
            {% endif %}
        </div>

        <!-- Marque -->
        <div class="field-group">
            <label class="block text-gray-300 text-sm font-medium mb-2">
                <i class="fas fa-tag mr-1 text-green-500"></i> Marque <span class="text-red-400">*</span>
            </label>
            {% render_field vehicule_form.marque %}
            {% if vehicule_form.marque.errors %}
                <p class="text-red-500 text-xs mt-1">{{ vehicule_form.marque.errors.0 }}</p>
            {% endif %}
        </div>

        <!-- Modèle -->
        <div class="field-group">
            <label class="block text-gray-300 text-sm font-medium mb-2">
                <i class="fas fa-car-side mr-1 text-green-500"></i> Modèle <span class="text-red-400">*</span>
            </label>
            {% render_field vehicule_form.modele %}
            {% if vehicule_form.modele.errors %}
 finals               <p class="text-red-500 text-xs mt-1">{{ vehicule_form.modele.errors.0 }}</p>
            {% endif %}
        </div>

        <!-- Catégorie -->
        <div class="field-group">
            <label class="block text-gray-300 text-sm font-medium mb-2">
                <i class="fas fa-layer-group mr-1 text-green-500"></i> Catégorie <span class="text-red-400">*</span>
            </label>
            {% render_field vehicule_form.categorie %}
            <div id="sc-loading" class="htmx-indicator hidden text-xs text-gray-400 mt-1">
                <i class="fas fa-spinner fa-spin mr-1"></i> Chargement...
            </div>
            {% if vehicule_form.categorie.errors %}
                <p class="text-red-500 text-xs mt-1">{{ vehicule_form.categorie.errors.0 }}</p>
            {% endif %}
        </div>

        <!-- SOUS-CATÉGORIE : CACHÉE PAR DÉFAUT -->
        <div id="sous-categorie-wrapper" class="hidden field-group md:col-span-2 lg:col-span-1">
            <!-- Remplacé par HTMX -->
        </div>

        <!-- Puissance -->
        <div class="field-group">
            <label class="block text-gray-300 text-sm font-medium mb-2">
                <i class="fas fa-tachometer-alt mr-1 text-green-500"></i> Puissance (CV) <span class="text-red-400">*</span>
            </label>
            {% render_field vehicule_form.puissance_fiscale %}
        </div>

        <!-- Nombre de places -->
        <div class="field-group">
            <label class="block text-gray-300 text-sm font-medium mb-2">
                <i class="fas fa-users mr-1 text-green-500"></i> Nombre de places <span class="text-red-400">*</span>
            </label>
            {% render_field vehicule_form.nombre_places %}
        </div>

        <!-- Carburant -->
        <div class="field-group">
            <label class="block text-gray-300 text-sm font-medium mb-2">
                <i class="fas fa-gas-pump mr-1 text-green-500"></i> Carburant <span class="text-red-400">*</span>
            </label>
            {% render_field vehicule_form.carburant %}
        </div>

        <!-- Champs cachés -->
        {% render_field vehicule_form.charge_utile type="hidden" %}
        <div class="hidden">
            {{ vehicule_form.valeur_neuve }}
            {{ vehicule_form.valeur_venale }}
        </div>
    </div>
</div>

</body>
</html>