{% load humanize %}

<div class="bg-gray-900 rounded-xl border border-gray-800 shadow-2xl overflow-hidden relative max-w-2xl mx-auto">

    <div class="absolute top-0 inset-x-0 h-1 bg-gradient-to-r from-transparent via-green-500 to-transparent opacity-75"></div>

    {% if error %}
        <div class="p-8 text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-500/10 text-red-500 mb-4 border border-red-500/20">
                <i class="fas fa-times text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-white mb-2">Une erreur est survenue</h3>
            <p class="text-red-300 bg-red-900/20 border border-red-900/50 rounded-lg p-4 text-sm">{{ error }}</p>
        </div>
    {% else %}
        <div class="p-8">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-green-500/10 rounded-full mb-5 ring-1 ring-green-500/30 shadow-[0_0_15px_rgba(34,197,94,0.2)]">
                    <i class="fas fa-check text-4xl text-green-500"></i>
                </div>
                <h2 class="text-2xl font-bold text-white tracking-tight">
                    {{ success_message|default:"Opération réussie !" }}
                </h2>
                <p class="text-gray-400 text-sm mt-2">Le dossier a été traité et validé avec succès.</p>
            </div>

            <div class="bg-gray-800/50 rounded-xl p-6 border border-gray-700/50 mb-8">
                <div class="grid grid-cols-2 gap-y-6 gap-x-4">
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wider font-medium mb-1">N° Police</p>
                        <p class="text-white font-mono font-semibold text-lg tracking-tight">
                            {{ contrat.numero_police|default:"—" }}
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-500 uppercase tracking-wider font-medium mb-1">Prime TTC</p>
                        <p class="text-green-400 font-bold text-lg">
                            {{ contrat.prime_ttc|default_if_none:0|floatformat:0|intcomma }} <span class="text-sm font-normal text-gray-400">FCFA</span>
                        </p>
                    </div>

                    <div class="col-span-2 border-t border-dashed border-gray-700/70"></div>

                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wider font-medium mb-1">Client</p>
                        <p class="text-gray-200 font-semibold truncate">
                            {{ contrat.client.nom_complet|default:"—" }}
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-500 uppercase tracking-wider font-medium mb-1">Véhicule</p>
                        <p class="text-gray-200 font-semibold">
                            {{ contrat.vehicule.immatriculation|default:"—" }}
                        </p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <a href="{% url 'contracts:detail_contrat' pk=contrat.pk %}"
                   class="sm:col-span-2 w-full bg-green-600 hover:bg-green-500 text-white font-semibold py-3 px-4 rounded-lg shadow-lg shadow-green-900/20 transition-all transform hover:-translate-y-0.5 text-center flex justify-center items-center gap-2">
                    <i class="fas fa-eye"></i> Voir le dossier complet
                </a>

                {% with att=contrat.link_attestation|default_if_none:'' carte=contrat.link_carte_brune|default_if_none:'' %}

                    {# --- CAS 1 : Documents disponibles --- #}
                    {% if att or carte %}
                        {% if att %}
                            <a href="{{ att }}" target="_blank" rel="noopener noreferrer"
                               class="flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-gray-200 border border-gray-700 transition-colors text-sm font-medium">
                                <i class="fas fa-file-pdf text-red-400"></i> Attestation
                            </a>
                        {% endif %}

                        {% if carte %}
                            <a href="{{ carte }}" target="_blank" rel="noopener noreferrer"
                               class="flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-gray-200 border border-gray-700 transition-colors text-sm font-medium">
                                <i class="fas fa-id-card text-yellow-500"></i> Carte Brune
                            </a>
                        {% endif %}

                        <a href="{% url 'contracts:telecharger_documents' pk=contrat.pk %}"
                           download
                           class="{% if not att or not carte %}sm:col-span-2{% endif %} flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-gray-200 border border-gray-700 transition-colors text-sm font-medium">
                            <i class="fas fa-download text-blue-400"></i> Tout télécharger
                        </a>

                    {# --- CAS 2 : Documents manquants (Bouton Récupérer) --- #}
                    {% else %}
                        <div class="sm:col-span-2 mt-2 p-3 bg-yellow-900/20 border border-yellow-700/50 rounded-lg text-center">
                            <p class="text-yellow-200 text-sm mb-3">
                                <i class="fas fa-exclamation-triangle mr-1"></i> Documents en attente de génération
                            </p>
                            <form method="post" action="{% url 'contracts:recuperer_documents' contrat.pk %}">
                                {% csrf_token %}
                                <button type="submit"
                                        class="w-full px-5 py-2.5 bg-yellow-600 hover:bg-yellow-500 text-white font-semibold rounded-lg shadow-lg transition-all transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                                    <i class="fas fa-sync-alt animate-reverse"></i>
                                    <span>Tenter de récupérer les documents</span>
                                </button>
                            </form>
                        </div>
                    {% endif %}

                {% endwith %}
            </div>
        </div>
    {% endif %}
</div>