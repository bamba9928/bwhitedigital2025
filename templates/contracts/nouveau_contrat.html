{% extends 'base.html' %}
{% load humanize %}

{% block title %}Nouveau Contrat - BWHITE DIGITAL{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
  <div class="mb-8 text-center">
    <h1 class="text-4xl font-bold text-white mb-3">
      <i class="fas fa-file-contract mr-3 text-primary-green"></i> Nouveau Contrat
    </h1>
  </div>

  <div id="contrat-form-wrapper">
    <form id="contrat-form"
          hx-post="{% url 'contracts:emettre_contrat' %}"
          hx-target="#emission-result"
          hx-swap="innerHTML"
          hx-timeout="65000"
          method="POST"
          autocomplete="off"
          novalidate>
      {% csrf_token %}

      {% include "contracts/partials/_client_form.html" %}
      {% include "contracts/partials/_vehicule_form.html" %}
      {% include "contracts/partials/_simulation_form.html" %}
    </form>
  </div>

  <div id="simulation-result" class="mt-8 hidden"></div>
  <div id="emission-result" class="mt-8 hidden"></div>
</div>

<script>
(function () {
  'use strict';

  function boot() {
    const form = document.getElementById('contrat-form');
    if (!form) return;

    const formWrapper = document.getElementById('contrat-form-wrapper');
    const simulationResult = document.getElementById('simulation-result');
    const emissionResult = document.getElementById('emission-result');

    // =========================
    // 1) Champs requis
    // =========================
    const requiredIds = [
      'id_prenom', 'id_nom', 'id_telephone', 'id_adresse',
      'id_immatriculation', 'id_marque', 'id_modele', 'id_categorie',
      'id_carburant', 'id_puissance_fiscale', 'id_nombre_places',
      'id_duree', 'id_date_effet'
    ];

    function enforceRequired() {
      requiredIds.forEach(id => {
        const el = document.getElementById(id);
        if (el && el.offsetParent !== null) {
          el.setAttribute('required', 'required');
          el.setAttribute('aria-required', 'true');
        }
      });
    }
    enforceRequired();

    // =========================
    // 2) Uppercase auto
    // =========================
    const uppercaseFields = form.querySelectorAll(
      'input[type="text"]:not([data-no-uppercase]):not([readonly]), ' +
      'textarea:not([data-no-uppercase])'
    );

    uppercaseFields.forEach(input => {
      input.addEventListener('input', function (e) {
        if (this.dataset.noUppercase !== undefined) return;

        const start = this.selectionStart;
        const end = this.selectionEnd;
        const oldValue = this.value;
        const newValue = oldValue.toUpperCase();

        if (oldValue !== newValue) {
          this.value = newValue;
          // Maintenir la position du curseur
          this.setSelectionRange(start, end);
        }
      });
    });

    // =========================
    // 3) Logique Catégorie
    // =========================
    const categorieSelect = document.getElementById('id_categorie');
    const sousCatWrapper = document.getElementById('sous-categorie-wrapper');
    const chargeUtileWrapper = document.getElementById('charge-utile-wrapper');

    function toggleDependentFields() {
      if (!categorieSelect) return;

      let val = categorieSelect.value;

      // Support Select2
      if (typeof $ !== 'undefined' && $.fn?.select2) {
        const $cat = $(categorieSelect);
        if ($cat.data('select2')) {
          val = $cat.val();
        }
      }

      val = String(val || '').trim();
      const isTPC = val === '520';
      const isMoto = val === '550';
      const showSousCat = isTPC || isMoto;

      // Gestion sous-catégorie
      if (sousCatWrapper) {
        if (showSousCat) {
          sousCatWrapper.classList.remove('hidden');

          // Chargement initial HTMX
          const sousCatField = sousCatWrapper.querySelector('#id_sous_categorie');
          if (!sousCatField && window.htmx) {
            const url = sousCatWrapper.getAttribute('hx-get');
            if (url) {
              const fullUrl = url.includes('?')
                ? `${url}&categorie=${encodeURIComponent(val)}`
                : `${url}?categorie=${encodeURIComponent(val)}`;
              htmx.ajax('GET', fullUrl, { target: sousCatWrapper });
            }
          }
        } else {
          sousCatWrapper.classList.add('hidden');
        }
      }

      // Gestion du champ sous-catégorie
      const sousCatField = document.getElementById('id_sous_categorie');
      if (sousCatField) {
        if (showSousCat) {
          sousCatField.disabled = false;
          sousCatField.setAttribute('required', 'required');
          sousCatField.setAttribute('aria-required', 'true');
        } else {
          sousCatField.disabled = true;
          sousCatField.removeAttribute('required');
          sousCatField.setAttribute('aria-required', 'false');
          sousCatField.setAttribute('aria-disabled', 'true');

          // Réinitialisation de la valeur
          if (typeof $ !== 'undefined' && $.fn?.select2 && $(sousCatField).data('select2')) {
            $(sousCatField).val('').trigger('change.select2');
          } else {
            sousCatField.value = '';
          }
        }
      }

      // Gestion charge utile
      const chargeUtileField = document.getElementById('id_charge_utile');
      if (chargeUtileWrapper) {
        chargeUtileWrapper.classList.toggle('hidden', !isTPC);
      }

      if (chargeUtileField) {
        if (isTPC) {
          chargeUtileField.disabled = false;
          chargeUtileField.setAttribute('required', 'required');
          // Valeur par défaut si vide
          if (!chargeUtileField.value) {
            chargeUtileField.value = '3500';
          }
        } else {
          chargeUtileField.disabled = true;
          chargeUtileField.removeAttribute('required');
          chargeUtileField.value = '0';
        }
      }

      // Nettoyage du cache AppManager
      if (window.appManager?.clearCache) {
        window.appManager.clearCache();
      }

      // Mise à jour validation
      if (window.appManager?.validate) {
        window.appManager.validate(false);
      }
    }

    // Initialisation catégorie
    if (categorieSelect) {
      // Exécution initiale
      toggleDependentFields();

      // Événement natif
      categorieSelect.addEventListener('change', toggleDependentFields);

      // Support Select2
      if (typeof $ !== 'undefined' && $.fn?.select2) {
        const $cat = $(categorieSelect);

        // Attendre l'initialisation complète de Select2
        const initSelect2Events = () => {
          if ($cat.data('select2')) {
            $cat
              .off('.fieldsToggle')
              .on('select2:select.fieldsToggle select2:clear.fieldsToggle change.fieldsToggle',
                toggleDependentFields);
          } else {
            setTimeout(initSelect2Events, 100);
          }
        };

        setTimeout(initSelect2Events, 200);
      }
    }

    // =========================
    // 4) Sauvegarde session
    // =========================
    const STORAGE_KEY = 'contrat_form_data';

    function saveFormData() {
      try {
        const fd = new FormData(form);
        const obj = {};

        fd.forEach((value, key) => {
          // Ignorer le CSRF token et les champs vides
          if (key !== 'csrfmiddlewaretoken' && value) {
            obj[key] = value;
          }
        });

        sessionStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
      } catch (e) {
        console.warn('Erreur sauvegarde formulaire:', e);
      }
    }

    function restoreFormData() {
      try {
        const raw = sessionStorage.getItem(STORAGE_KEY);
        if (!raw) return;

        const obj = JSON.parse(raw);

        Object.keys(obj).forEach(k => {
          const el = form.querySelector(`[name="${CSS.escape(k)}"]`);
          if (!el) return;

          if (el.type === 'checkbox' || el.type === 'radio') {
            el.checked = el.value === obj[k];
          } else {
            el.value = obj[k];

            // Support Select2
            if (typeof $ !== 'undefined' && $.fn?.select2) {
              const $el = $(el);
              if ($el.hasClass('select2-hidden-accessible')) {
                try {
                  $el.val(obj[k]).trigger('change.select2');
                } catch (e) {
                  console.warn('Erreur restauration Select2:', e);
                }
              }
            }
          }
        });

        // Re-toggle après restauration
        setTimeout(() => {
          toggleDependentFields();
          enforceRequired();
        }, 300);

      } catch (e) {
        console.warn('Erreur restauration formulaire:', e);
      }
    }

    function clearFormData() {
      try {
        sessionStorage.removeItem(STORAGE_KEY);
      } catch (e) {
        console.warn('Erreur nettoyage session:', e);
      }
    }

    // =========================
    // 5) Affichage formulaire
    // =========================
    function showFormWrapper() {
      if (formWrapper) formWrapper.classList.remove('hidden');

      if (simulationResult) {
        simulationResult.classList.add('hidden');
        simulationResult.innerHTML = '';
      }

      if (emissionResult) {
        emissionResult.classList.add('hidden');
        emissionResult.innerHTML = '';
      }

      restoreFormData();

      setTimeout(() => {
        if (formWrapper) {
          formWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 100);
    }

    // Export global
    window.showContractForm = showFormWrapper;

    // =========================
    // 6) HTMX hooks
    // =========================
    document.body.addEventListener('htmx:beforeRequest', function (e) {
      const elt = e.detail?.elt;
      if (elt && elt.closest('#contrat-form')) {
        saveFormData();
      }
    });

    document.body.addEventListener('htmx:afterSwap', function (e) {
      const target = e.detail?.target;
      if (!target) return;

      // Gestion résultats simulation/émission
      if (target.id === 'simulation-result' || target.id === 'emission-result') {
        const hasContent = target.innerHTML.trim() !== '';
        target.classList.toggle('hidden', !hasContent);

        if (hasContent) {
          // Masquer le formulaire si c'est le résultat d'émission
          if (target.id === 'emission-result' && formWrapper) {
            formWrapper.classList.add('hidden');
          }

          setTimeout(() => {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 100);
        }
      }

      // Réinitialisation sous-catégorie après chargement HTMX
      if (target.id === 'sous-categorie-wrapper' || target.querySelector?.('#id_sous_categorie')) {
        if (typeof $ !== 'undefined' && $.fn?.select2) {
          const $sc = $('#id_sous_categorie');
          if ($sc.length) {
            // Détruire l'instance existante
            if ($sc.data('select2')) {
              $sc.select2('destroy');
            }

            // Réinitialiser Select2
            $sc.select2({
              minimumResultsForSearch: Infinity,
              placeholder: 'Genre / Sous-catégorie',
              width: '100%',
              allowClear: true,
              dropdownCssClass: 'animate-fadeInCalendar'
            });
          }
        }

        // Re-toggle après injection
        setTimeout(() => {
          toggleDependentFields();
          enforceRequired();
        }, 150);
      }
    });

    document.body.addEventListener('htmx:afterOnLoad', function (e) {
      const body = e.detail?.xhr?.responseText || '';

      // Détecter succès émission
      const successIndicators = [
        'bg-green-',
        'Contrat émis',
        'Émission réussie',
        'success-message',
        'alert-success'
      ];

      if (successIndicators.some(indicator => body.includes(indicator))) {
        clearFormData();

        // Toast de succès si disponible
        if (window.appManager?.toast) {
          window.appManager.toast('Contrat émis avec succès !', 'success', 5000);
        }
      }
    });

    // Gestion des erreurs HTMX
    document.body.addEventListener('htmx:responseError', function (e) {
      if (e.detail?.elt?.closest('#contrat-form')) {
        const status = e.detail.xhr?.status;
        let message = 'Une erreur est survenue lors de la soumission du formulaire.';

        if (status === 400) {
          message = 'Veuillez vérifier les informations saisies.';
        } else if (status === 500) {
          message = 'Erreur serveur. Veuillez réessayer.';
        }

        if (window.appManager?.toast) {
          window.appManager.toast(message, 'error', 5000);
        }
      }
    });

    // =========================
    // 7) Bouton restaurer
    // =========================
    document.body.addEventListener('click', function (e) {
      const btn = e.target.closest('[data-action="restore-form"]');
      if (btn) {
        e.preventDefault();
        showFormWrapper();
      }
    });

    // =========================
    // 8) Nettoyage au départ
    // =========================
    window.addEventListener('beforeunload', function () {
      // Sauvegarder avant de quitter si le formulaire n'est pas vide
      const fd = new FormData(form);
      let hasData = false;

      fd.forEach((value, key) => {
        if (key !== 'csrfmiddlewaretoken' && value) {
          hasData = true;
        }
      });

      if (hasData) {
        saveFormData();
      }
    });

    // =========================
    // 9) Init finale
    // =========================
    restoreFormData();
  }
    $('#id_marque, #id_categorie, #id_carburant, #id_modele')
  .on('change.app', function(){ this.dispatchEvent(new Event('input', {bubbles:true})) });

  // Exécution selon l'état du DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
})();
</script>
{% endblock %}