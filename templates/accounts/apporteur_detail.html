{% extends "base.html" %}
{% load humanize %}
{% block title %}Mon contrat apporteur{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">

    <div class="card bg-slate-800 rounded-xl shadow-lg border border-slate-700 overflow-hidden">

        <div class="p-6 border-b border-slate-700 flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center text-green-500">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </div>
            <h1 class="text-xl font-bold text-white">Contrat & conditions</h1>
        </div>

        <div class="p-6">
            {% if conditions_html %}
            <div class="mb-8">
                <label class="block text-sm font-semibold text-slate-300 mb-2">Conditions contractuelles</label>
                <div class="bg-white text-slate-900 rounded-lg p-4 h-64 overflow-y-auto text-sm leading-relaxed shadow-inner border border-slate-600">
                    {{ conditions_html|safe }}
                </div>
            </div>
            {% endif %}

            <form method="post" enctype="multipart/form-data" id="signature-form" class="space-y-8">
                {% csrf_token %}

                {% if form.non_field_errors %}
                  <div class="mb-4 p-3 rounded bg-red-900/40 border border-red-500 text-red-200 text-sm">
                      {% for error in form.non_field_errors %}
                          <p>{{ error }}</p>
                      {% endfor %}
                  </div>
                {% endif %}

                {% for field in form %}
                    {% if field.errors %}
                        <div class="mb-2 p-2 rounded bg-red-900/20 border border-red-500/30 text-xs text-red-300">
                            <strong>{{ field.label }} :</strong>
                            {{ field.errors|striptags }}
                        </div>
                    {% endif %}
                {% endfor %}
                <div class="flex items-start gap-3">
                    <div class="relative flex items-start">
                        <input type="checkbox" id="a_lu_et_approuve" name="a_lu_et_approuve" required
                               {% if onboarding.a_lu_et_approuve %}checked{% endif %}
                               class="peer h-5 w-5 cursor-pointer appearance-none rounded border border-slate-500 bg-slate-700 transition-all checked:border-green-500 checked:bg-green-500 hover:border-green-400 focus:ring-2 focus:ring-green-500/30 mt-0.5">
                        <svg class="pointer-events-none absolute top-1 left-1 h-3.5 w-3.5 text-white opacity-0 peer-checked:opacity-100 mt-0.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <label for="a_lu_et_approuve" class="text-sm text-slate-300 cursor-pointer select-none leading-relaxed">
                        Je déclare avoir lu et j’accepte les termes du contrat et les conditions générales d'utilisation.
                    </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-group">
                        <label class="block text-sm font-medium text-slate-400 mb-2">CNI Recto (jpg/png/pdf)</label>

                        <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-600 rounded-lg cursor-pointer bg-slate-700/30 hover:bg-slate-700 hover:border-green-500 transition-all group relative">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6 z-10">
                                <svg class="w-8 h-8 mb-2 text-slate-400 group-hover:text-green-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                <p class="text-xs text-slate-400 group-hover:text-slate-200" id="text-recto">Cliquez pour sélectionner</p>
                                <p id="filename-recto" class="text-xs text-green-400 mt-1 font-medium truncate px-2 max-w-[200px]"></p>
                            </div>
                            <input type="file" name="cni_recto" class="hidden" accept=".jpg,.jpeg,.png,.pdf"
                                   onchange="updateFileName(this, 'filename-recto', 'text-recto')" />
                        </label>

                        {% if onboarding.cni_recto %}
                            <div class="mt-2 flex items-center gap-2 text-xs bg-slate-900/50 p-2 rounded border border-slate-700">
                                <span class="text-green-500">✓ Fichier actuel :</span>
                                <a href="{{ onboarding.cni_recto.url }}" target="_blank" class="text-blue-400 hover:underline hover:text-blue-300 flex items-center gap-1">
                                    Voir le document
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                </a>
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label class="block text-sm font-medium text-slate-400 mb-2">CNI Verso (jpg/png/pdf)</label>

                        <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-600 rounded-lg cursor-pointer bg-slate-700/30 hover:bg-slate-700 hover:border-green-500 transition-all group relative">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6 z-10">
                                <svg class="w-8 h-8 mb-2 text-slate-400 group-hover:text-green-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                <p class="text-xs text-slate-400 group-hover:text-slate-200" id="text-verso">Cliquez pour sélectionner</p>
                                <p id="filename-verso" class="text-xs text-green-400 mt-1 font-medium truncate px-2 max-w-[200px]"></p>
                            </div>
                            <input type="file" name="cni_verso" class="hidden" accept=".jpg,.jpeg,.png,.pdf"
                                   onchange="updateFileName(this, 'filename-verso', 'text-verso')" />
                        </label>

                        {% if onboarding.cni_verso %}
                            <div class="mt-2 flex items-center gap-2 text-xs bg-slate-900/50 p-2 rounded border border-slate-700">
                                <span class="text-green-500">✓ Fichier actuel :</span>
                                <a href="{{ onboarding.cni_verso.url }}" target="_blank" class="text-blue-400 hover:underline hover:text-blue-300 flex items-center gap-1">
                                    Voir le document
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="border-t border-slate-700 pt-6">
                    <div class="flex justify-between items-center mb-3">
                        <label class="block text-sm font-medium text-slate-300">Votre Signature</label>
                        <div class="flex gap-2">
                            <button type="button" id="undo_sig" class="text-xs px-2 py-1 bg-slate-700 text-slate-300 rounded hover:bg-slate-600 transition">Annuler trait</button>
                            <button type="button" id="clear_sig" class="text-xs px-2 py-1 bg-red-500/10 text-red-400 rounded hover:bg-red-500/20 transition flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                Effacer tout
                            </button>
                        </div>
                    </div>

                    <div class="relative rounded-lg overflow-hidden border-2 border-slate-600 bg-white hover:border-slate-500 transition-colors">
                        <canvas id="sigpad" class="w-full h-48 cursor-crosshair block touch-none"></canvas>
                        <div class="absolute bottom-2 right-2 text-[10px] text-gray-400 pointer-events-none select-none">Signez dans cette zone</div>
                    </div>

                    <input type="hidden" name="signature_data_url" id="signature_image_input">

                    {% if onboarding.signature_image %}
                        <div class="mt-3 p-3 bg-slate-900/50 rounded border border-slate-700 inline-block">
                            <p class="text-xs text-slate-400 mb-2">Signature enregistrée :</p>
                            <img src="{{ onboarding.signature_image.url }}" alt="Signature" class="h-12 bg-white rounded px-2 py-1">
                        </div>
                    {% endif %}
                </div>

                <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t border-slate-700">
                    <button type="submit" class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg shadow-lg shadow-green-900/20 transition-all transform hover:-translate-y-0.5 flex justify-center items-center gap-2">
                        <span>Valider et Signer</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    </button>

                    {% if onboarding.a_lu_et_approuve %}
                        <a href="{% url 'accounts:contrat_pdf' %}" class="px-5 py-3 bg-blue-600 hover:bg-blue-500 text-white font-semibold rounded-lg shadow transition-all text-center flex justify-center items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            PDF
                        </a>
                        <button type="button" onclick="window.print()" class="px-5 py-3 bg-slate-700 hover:bg-slate-600 text-slate-200 font-semibold rounded-lg transition-all flex justify-center items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                            Imprimer
                        </button>
                    {% endif %}
                </div>

                {% if onboarding.status %}
                    <div class="text-center pt-2">
                        <p class="text-xs text-slate-500">
                            Statut actuel : <span class="text-slate-300 font-medium">{{ onboarding.get_status_display }}</span>
                            {% if onboarding.approuve_at %}
                                • Signé le {{ onboarding.approuve_at|date:"d/m/Y à H:i" }}
                            {% endif %}
                        </p>
                    </div>
                {% endif %}
            </form>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
<script>
    // Fonction pour afficher le nom du fichier sélectionné
    function updateFileName(input, nameId, textId) {
        const nameDisplay = document.getElementById(nameId);
        const textDisplay = document.getElementById(textId);
        if (input.files && input.files.length > 0) {
            nameDisplay.textContent = input.files[0].name;
            textDisplay.textContent = "Fichier sélectionné :";
            textDisplay.classList.add('text-green-400');
        } else {
            nameDisplay.textContent = "";
            textDisplay.textContent = "Cliquez pour sélectionner";
            textDisplay.classList.remove('text-green-400');
        }
    }

    (function(){
        const canvas = document.getElementById('sigpad');
        const input = document.getElementById('signature_image_input');
        const form = document.getElementById('signature-form');

        if (!canvas) return;

        // --- Gestion DPI Signature (Crucial pour mobile/retina) ---
        let signaturePad;

        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            // On récupère la taille réelle affichée en CSS
            const width = canvas.offsetWidth;
            const height = canvas.offsetHeight; // Ou une hauteur fixe si canvas.offsetHeight est 0 (ex: caché)

            // Si le canvas n'est pas visible, on ne fait rien pour l'instant
            if (width === 0) return;

            canvas.width = width * ratio;
            canvas.height = height * ratio;
            canvas.getContext("2d").scale(ratio, ratio);

            // On réinitialise le pad mais on garde les données si elles existent (pour le redimensionnement fenêtre)
            if (signaturePad) {
                const data = signaturePad.toData();
                signaturePad.clear(); // Important pour clean le cache interne
                signaturePad.fromData(data);
            }
        }

        // Initialisation
        signaturePad = new SignaturePad(canvas, {
            minWidth: 0.7,
            maxWidth: 2.0,
            penColor: 'rgb(0, 0, 0)',
            backgroundColor: 'rgb(255, 255, 255)'
        });

        // Appel initial et au redimensionnement
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas(); // Premier appel

        // --- Boutons ---
        document.getElementById('clear_sig').onclick = () => signaturePad.clear();

        document.getElementById('undo_sig').onclick = () => {
            const data = signaturePad.toData();
            if (data.length) {
                data.pop(); // Enlève le dernier trait
                signaturePad.fromData(data);
            }
        };

        // --- Soumission ---
        form.addEventListener('submit', function(e) {
            // Vérification si une signature est requise (optionnel selon votre logique)
            // Si le pad n'est pas vide, on met à jour l'input caché
            if (!signaturePad.isEmpty()) {
                input.value = signaturePad.toDataURL('image/png');
            } else {
                // Si pas de signature, on peut soit laisser vide (si édition sans re-signer)
                // soit bloquer. Ici je laisse passer car l'utilisateur peut avoir déjà signé avant.
                // Si vous voulez forcer :
                // e.preventDefault(); alert("Merci de signer avant de valider.");
            }
        });
    })();
</script>
{% endblock %}