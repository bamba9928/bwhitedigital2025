<!DOCTYPE html>
{% load static %}
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>
            {% block title %}Bwhite Digital{% endblock %}
        </title>
        <!-- Alpine en premier -->
        <script defer
                src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <!-- Tailwind CDN -->
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { 'primary-green': '#00FF00' },
          fontFamily: {
            inter: ['Inter','ui-sans-serif','system-ui','Segoe UI','Roboto','Helvetica Neue','Arial']
          }
        }
      }
    }
        </script>
        <style>
    [x-cloak]{display:none !important;}
    .mobile-menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:30;}
    /* .mobile-sidebar est défini dans style.css */
    .mobile-sidebar.open{transform:translateX(0);}
    .sidebar-transition{transition:transform .3s ease-in-out;}
    /* .btn-primary-modern et .ripple sont définis dans style.css */
        </style>
        <!-- Libs CSS -->
        <link rel="stylesheet"
              href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
        <link rel="stylesheet"
              href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
              rel="stylesheet">
        <link rel="stylesheet"
              href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
              rel="stylesheet">
        <link rel="stylesheet" href="{% static 'css/style.css' %}">
        <link rel="manifest" href="{% static 'manifest.json' %}">
        <meta name="theme-color" content="#00FF00">
        <!-- iOS PWA -->
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="apple-mobile-web-app-title" content="BWHITE">
        <link rel="apple-touch-icon"
              sizes="180x180"
              href="{% static 'icons/apple-touch-icon.png' %}">
        <!-- Favicons -->
        <link rel="icon"
              type="image/png"
              sizes="16x16"
              href="{% static 'icons/favicon-16x16.png' %}">
        <link rel="icon"
              type="image/png"
              sizes="32x32"
              href="{% static 'icons/favicon-32x32.png' %}">
        <link rel="icon"
              type="image/png"
              sizes="192x192"
              href="{% static 'icons/android-chrome-192x192.png' %}">
        <link rel="icon"
              type="image/png"
              sizes="512x512"
              href="{% static 'icons/android-chrome-512x512.png' %}">
        {% block extra_css %}{% endblock %}
    </head>
    <body class="min-h-screen bg-gradient-to-br from-gray-950 via-gray-900 to-gray-950 text-gray-200 font-inter"
          x-data="{ isMenuOpen:false }"
          :class="{ 'overflow-hidden': isMenuOpen && window.innerWidth < 1024 }">
        <!-- Banner PWA -->
        <div id="pwa-install-banner"
             class="hidden fixed bottom-4 left-4 right-4 md:left-4 md:w-96 bg-gray-800/50 backdrop-blur-sm text-white p-6 rounded-xl shadow-2xl z-50 border border-gray-700">
            <div class="flex items-center justify-between gap-4 flex-wrap">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-green-500/10 flex items-center justify-center">
                        <i class="fas fa-download text-primary-green text-xl"></i>
                    </div>
                    <span class="font-medium">Installer BWHITE DIGITAL ?</span>
                </div>
                <div class="flex gap-3">
                    <button onclick="window.BWHITEUtils && window.BWHITEUtils.installPWA()"
                            class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 px-6 py-2.5 rounded-lg font-semibold transition-all duration-300 shadow-lg shadow-green-500/20 hover:shadow-green-500/40 hover:scale-105 active:scale-95">
                        Oui
                    </button>
                    <button onclick="document.getElementById('pwa-install-banner').classList.add('hidden')"
                            class="bg-gray-700 hover:bg-gray-600 px-6 py-2.5 rounded-lg font-medium transition-all duration-300 hover:scale-105 active:scale-95">
                        Non
                    </button>
                </div>
            </div>
        </div>
        <!-- Indicateur hors ligne -->
        <div id="offline-indicator"
             class="hidden fixed top-0 left-0 w-full bg-yellow-600 text-white text-center py-2 z-50 shadow-lg">
            <i class="fas fa-wifi-slash mr-2"></i>Mode hors-ligne
        </div>
        <!-- Navigation -->
        <nav class="sticky top-0 z-50 bg-gray-900/95 backdrop-blur-sm border-b border-gray-800 shadow-lg">
            <div class="px-4 md:px-6 py-3">
                <div class="flex items-center justify-between">
                    <!-- Brand -->
                    <a href="{% url 'dashboard:home' %}"
                       class="flex items-center gap-2 group"
                       aria-label="Accueil Bwhite Digital">
                        <div class="inline-flex items-center justify-center w-8 h-8 rounded-md brand-chip shadow-md overflow-hidden relative group-hover:scale-110 transition duration-300"
                             role="img"
                             aria-label="Logo BWHITE DIGITAL">
                            <img src="{% static 'images/logo.png' %}"
                                 alt="BWHITE DIGITAL Logo"
                                 id="nav-main-logo"
                                 class="w-full h-full object-contain"
                                 loading="lazy">
                            <div id="nav-fallback-icon"
                                 class="hidden absolute inset-0 w-full h-full items-center justify-center">
                                <i class="fas fa-gem text-white text-xl" aria-hidden="true"></i>
                            </div>
                        </div>
                        <span class="text-xl font-bold bg-gradient-to-r from-primary-green to-green-400 bg-clip-text text-transparent">Bwhite Digital</span>
                    </a>
                    <script>
          document.addEventListener('DOMContentLoaded',function(){
            const logo=document.getElementById('nav-main-logo');
            const fb=document.getElementById('nav-fallback-icon');
            if(logo&&fb){ logo.onerror=function(){ this.classList.add('hidden'); fb.classList.remove('hidden'); fb.classList.add('flex'); }; }
          });
                    </script>
                    {% if user.is_authenticated %}
                        <div class="flex items-center gap-3">
                            <!-- Actions desktop -->
                            <div class="hidden lg:flex items-center gap-3">
                                <a href="{% url 'contracts:nouveau_contrat' %}"
                                   class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-3 rounded-xl flex items-center gap-3 transition-all duration-300 shadow-lg shadow-blue-500/20 hover:shadow-blue-500/40 font-semibold ripple btn-primary-modern">
                                    <i class="fas fa-plus text-lg"></i><span>Nouveau Contrat</span>
                                </a>
                                {% if user.role == 'ADMIN' %}
                                    <a href="{% url 'accounts:nouveau_apporteur' %}"
                                       class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white px-6 py-3 rounded-xl flex items-center gap-3 transition-all duration-300 shadow-lg shadow-green-500/20 hover:shadow-green-500/40 font-semibold ripple btn-primary-modern">
                                        <i class="fas fa-user-plus text-lg"></i><span>Ajouter Apporteur</span>
                                    </a>
                                {% endif %}
                            </div>
                            <!-- Menu profil -->
                            <div x-data="{ open:false }" @click.outside="open=false" class="relative">
                                <button @click="open=!open"
                                        class="flex items-center gap-2 px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition"
                                        :aria-expanded="open.toString()"
                                        aria-controls="profile-menu">
                                    <i class="fas fa-user-circle text-xl"></i>
                                    <span class="hidden sm:inline">{{ user.username }}</span>
                                    <i class="fas fa-chevron-down text-xs"
                                       :class="open ? 'rotate-180 transition' : 'transition'"></i>
                                </button>
                                <div x-show="open"
                                     x-transition:enter="transition ease-out duration-100"
                                     x-transition:enter-start="transform opacity-0 scale-95"
                                     x-transition:enter-end="transform opacity-100 scale-100"
                                     x-transition:leave="transition ease-in duration-75"
                                     x-transition:leave-start="transform opacity-100 scale-100"
                                     x-transition:leave-end="transform opacity-0 scale-95"
                                     class="absolute right-0 mt-2 w-48 bg-gray-800 rounded-lg shadow-xl py-2 border border-gray-700"
                                     x-cloak
                                     id="profile-menu">
                                    <a href="{% url 'accounts:profile' %}"
                                       class="w-full text-left px-4 py-3 text-gray-300 hover:bg-gray-800/70 hover:text-white rounded-lg transition-all duration-200 flex items-center gap-3 group">
                                        <div class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center group-hover:bg-blue-500/20 transition-colors">
                                            <i class="fas fa-user text-blue-400"></i>
                                        </div>
                                        <span class="font-medium">Mon Profil</span>
                                        <i class="fas fa-chevron-right ml-auto text-gray-500 group-hover:text-primary-green group-hover:translate-x-1 transition-all text-xs"></i>
                                    </a>
                                    <form action="{% url 'accounts:logout' %}" method="post">
                                        {% csrf_token %}
                                        <button type="submit"
                                                class="w-full text-left px-4 py-3 text-gray-300 hover:bg-red-500/10 hover:text-red-400 rounded-lg transition-all duration-200 flex items-center gap-3 group border border-transparent hover:border-red-500/30">
                                            <div class="w-8 h-8 rounded-lg bg-red-500/10 flex items-center justify-center group-hover:bg-red-500/20 transition-colors">
                                                <i class="fas fa-sign-out-alt text-red-400"></i>
                                            </div>
                                            <span class="font-medium">Déconnexion</span>
                                            <i class="fas fa-chevron-right ml-auto text-gray-500 group-hover:text-red-400 group-hover:translate-x-1 transition-all text-xs"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                            <!-- Bouton menu mobile -->
                            <button @click="isMenuOpen=!isMenuOpen"
                                    class="lg:hidden w-12 h-12 rounded-full bg-gray-800 hover:bg-gray-700 text-gray-300 hover:text-white flex items-center justify-center transition-all duration-300 shadow-lg hover:shadow-primary-green/20 hover:scale-110 active:scale-95"
                                    :aria-expanded="isMenuOpen.toString()"
                                    aria-controls="mobile-sidebar">
                                <i class="fas fa-bars text-xl" x-show="!isMenuOpen"></i>
                                <i class="fas fa-times text-xl" x-show="isMenuOpen" x-cloak></i>
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- Messages -->
            {% if messages %}
                <div class="px-4 md:px-6 py-2 bg-gray-800 border-t border-gray-700">
                    <div class="space-y-2">
                        {% for message in messages %}
                            <div class="text-sm px-3 py-2 rounded border flex items-center justify-between {% if 'success' in message.tags %} text-green-300 border-green-700 bg-green-900/20 {% elif 'warning' in message.tags %} text-yellow-300 border-yellow-700 bg-yellow-900/20 {% elif 'danger' in message.tags or 'error' in message.tags %} text-red-300 border-red-700 bg-red-900/20 {% else %} text-gray-300 border-gray-600 bg-gray-700/30 {% endif %}">
                                <span>{{ message }}</span>
                                <button onclick="this.parentElement.style.display='none';"
                                        class="ml-4 opacity-75 hover:opacity-100 text-lg"
                                        aria-label="Fermer la notification">&times;</button>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </nav>
        {% block banner %}
            {% include "includes/_top_banner.html" %}
        {% endblock %}
        <div class="flex min-h-[calc(100vh-64px)]">
            {% if user.is_authenticated %}
                <!-- Overlay Mobile -->
                <div x-show="isMenuOpen"
                     x-transition:enter="transition-opacity duration-300"
                     x-transition:enter-start="opacity-0"
                     x-transition:enter-end="opacity-100"
                     x-transition:leave="transition-opacity duration-300"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0"
                     @click="isMenuOpen=false"
                     class="mobile-menu-overlay lg:hidden"
                     x-cloak></div>
                <!-- Sidebar -->
                <aside :class="{ 'translate-x-0': isMenuOpen, '-translate-x-full': !isMenuOpen }"
                       class="mobile-sidebar sidebar-transition bg-gray-900/95 border-r border-gray-800 lg:translate-x-0 lg:relative lg:inset-auto fixed inset-y-0 left-0 z-40 overflow-y-auto"
                       x-cloak
                       id="mobile-sidebar">
                    <div class="pt-20 lg:pt-4 p-4">
                        <!-- En-tête mobile -->
                        <div class="flex items-center justify-between mb-6 lg:hidden">
                            <span class="text-xl font-bold text-primary-green">Menu</span>
                            <button @click="isMenuOpen=false" class="text-gray-400 hover:text-white p-2">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <!-- Actions mobiles -->
                        <div class="lg:hidden mb-6 space-y-3">
                            <a href="{% url 'contracts:nouveau_contrat' %}"
                               @click="isMenuOpen=false"
                               class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-5 py-3 rounded-xl flex items-center gap-3 transition-all duration-300 shadow-lg shadow-blue-500/20 hover:shadow-blue-500/40 hover:translate-x-1 font-medium group">
                                <div class="w-10 h-10 rounded-lg bg-white/10 flex items-center justify-center group-hover:bg-white/20 transition-colors">
                                    <i class="fas fa-plus"></i>
                                </div>
                                <span>Nouveau Contrat</span>
                            </a>
                            {% if user.role == 'ADMIN' %}
                                <a href="{% url 'accounts:nouveau_apporteur' %}"
                                   @click="isMenuOpen=false"
                                   class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white px-5 py-3 rounded-xl flex items-center gap-3 transition-all duration-300 shadow-lg shadow-green-500/20 hover:shadow-green-500/40 hover:translate-x-1 font-medium group">
                                    <div class="w-10 h-10 rounded-lg bg-white/10 flex items-center justify-center group-hover:bg-white/20 transition-colors">
                                        <i class="fas fa-user-plus"></i>
                                    </div>
                                    <span>Ajouter Apporteur</span>
                                </a>
                            {% endif %}
                        </div>
                        <!-- Navigation -->
                        <ul class="space-y-1">
                            {% url 'dashboard:home' as dashboard_url %}
                            <li>
                                <a href="{{ dashboard_url }}"
                                   @click="if (window.innerWidth < 1024) isMenuOpen=false"
                                   class="flex items-center gap-3 px-3 py-2 text-gray-300 rounded-lg transition group {% if request.path == dashboard_url %} bg-gray-800 text-primary-green font-semibold {% else %} hover:bg-gray-800 hover:text-primary-green {% endif %}">
                                    <i class="fas fa-tachometer-alt group-hover:scale-110 transition"></i><span>Dashboard</span>
                                </a>
                            </li>
                            {% url 'contracts:liste_contrats' as contrats_url %}
                            <li>
                                <a href="{{ contrats_url }}"
                                   @click="if (window.innerWidth < 1024) isMenuOpen=false"
                                   class="flex items-center gap-3 px-3 py-2 text-gray-300 rounded-lg transition group {% if request.path == contrats_url %} bg-gray-800 text-primary-green font-semibold {% else %} hover:bg-gray-800 hover:text-primary-green {% endif %}">
                                    <i class="fas fa-file-contract group-hover:scale-110 transition"></i><span>Contrats</span>
                                </a>
                            </li>
                            {% url 'contracts:liste_clients' as clients_url %}
                            <li>
                                <a href="{{ clients_url }}"
                                   @click="if (window.innerWidth < 1024) isMenuOpen=false"
                                   class="flex items-center gap-3 px-3 py-2 text-gray-300 rounded-lg transition group {% if request.path == clients_url %} bg-gray-800 text-primary-green font-semibold {% else %} hover:bg-gray-800 hover:text-primary-green {% endif %}">
                                    <i class="fas fa-users group-hover:scale-110 transition"></i><span>Clients</span>
                                </a>
                            </li>
                            {% if user.role == 'APPORTEUR' %}
                                {% url 'payments:mes_paiements' as paiements_apporteur_url %}
                                <li>
                                    <a href="{{ paiements_apporteur_url }}"
                                       @click="if (window.innerWidth < 1024) isMenuOpen=false"
                                       class="flex items-center gap-3 px-3 py-2 text-gray-300 rounded-lg transition group {% if request.path == paiements_apporteur_url %} bg-gray-800 text-primary-green font-semibold {% else %} hover:bg-gray-800 hover:text-primary-green {% endif %}">
                                        <i class="fas fa-coins group-hover:scale-110 transition"></i><span>Mes paiements</span>
                                    </a>
                                </li>
                            {% endif %}
                            {% if user.role == 'ADMIN' %}
                                {% url 'accounts:liste_apporteurs' as apporteurs_url %}
                                <li>
                                    <a href="{{ apporteurs_url }}"
                                       @click="if (window.innerWidth < 1024) isMenuOpen=false"
                                       class="flex items-center gap-3 px-3 py-2 text-gray-300 rounded-lg transition group {% if request.path == apporteurs_url %} bg-gray-800 text-primary-green font-semibold {% else %} hover:bg-gray-800 hover:text-primary-green {% endif %}">
                                        <i class="fas fa-user-tie group-hover:scale-110 transition"></i><span>Apporteurs</span>
                                    </a>
                                </li>
                                {% url 'payments:liste_encaissements' as encaissements_url %}
                                <li>
                                    <a href="{{ encaissements_url }}"
                                       @click="if (window.innerWidth < 1024) isMenuOpen=false"
                                       class="flex items-center gap-3 px-3 py-2 text-gray-300 rounded-lg transition group {% if request.path == encaissements_url %} bg-gray-800 text-primary-green font-semibold {% else %} hover:bg-gray-800 hover:text-primary-green {% endif %}">
                                        <i class="fas fa-money-check-alt group-hover:scale-110 transition"></i><span>Paiements</span>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                </aside>
            {% endif %}
            <!-- Contenu principal -->
            <main class="flex-1 p-4 md:p-6 overflow-y-auto w-full">
                {% block content %}{% endblock %}
            </main>
        </div>
        <!-- Spinner global -->
        <div id="global-spinner"
             class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center backdrop-blur-sm">
            <div class="flex flex-col items-center gap-4 animate-pulse">
                <i class="fas fa-spinner fa-spin text-6xl text-primary-green"></i>
                <p class="text-white font-bold text-lg">Veuillez patienter...</p>
            </div>
        </div>
        <!-- Libs JS -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script defer
                src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <script defer src="https://unpkg.com/htmx.org@1.9.10"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
        <!-- App JS -->
        <script defer src="{% static 'js/app.js' %}"></script>
        <!-- Helpers côté client -->
        <script>const IS_AUTH = {% if user.is_authenticated %}true{% else %}false{% endif %};</script>
        <!-- Service Worker -->
        <script>
    if ('serviceWorker' in navigator){
      navigator.serviceWorker.register('/sw.js').catch(()=>{
        navigator.serviceWorker.register("{% static 'sw.js' %}");
      });
    }
        </script>
        <!-- Indicateur hors ligne -->
        <script>
    (function(){
      const bar=document.getElementById('offline-indicator');
      const paint=()=> bar && bar.classList.toggle('hidden', navigator.onLine);
      window.addEventListener('online',paint);
      window.addEventListener('offline',paint);
      paint();
    })();
        </script>
        <!-- PWA Installation -->
        <script>
    (function(){
      let deferredPrompt=null;
      const banner=document.getElementById('pwa-install-banner');
      window.BWHITEUtils={ installPWA:async function(){
        if(!deferredPrompt){ banner?.classList.add('hidden'); return; }
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt=null; banner?.classList.add('hidden');
      }};
      window.addEventListener('beforeinstallprompt',(e)=>{
        e.preventDefault(); deferredPrompt=e;
        if(IS_AUTH){ banner?.classList.remove('hidden'); }
      });
      window.addEventListener('appinstalled',()=>{ deferredPrompt=null; banner?.classList.add('hidden'); });
    })();
        </script>
        {% block extra_js %}
        {% endblock %}
    </body>
</html>
