<!DOCTYPE html>
{% load static %}
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>{% block title %}Bwhite Digital{% endblock %}</title>

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-green': '#00FF00',
                        'gray-750': '#2d3748',
                    },
                    fontFamily: {
                        inter: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        [x-cloak] { display: none !important; }
        .mobile-menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 30; backdrop-filter: blur(2px); }
        .sidebar-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Select2 Dark Mode Fixes */
        .select2-container--default .select2-selection--single {
            background-color: #1f2937 !important; border-color: #374151 !important; color: #e5e7eb !important;
            height: 42px !important; border-radius: 0.5rem !important; display: flex; align-items: center;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #e5e7eb !important; line-height: 42px !important; padding-left: 12px;
        }
        .select2-dropdown { background-color: #1f2937 !important; border-color: #374151 !important; }
        .select2-results__option { color: #e5e7eb; }
        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: #00FF00 !important; color: #000 !important;
        }
        .select2-search__field { background-color: #374151 !important; color: white !important; border-color: #4b5563 !important; }
    </style>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <link rel="manifest" href="{% url 'manifest' %}">
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BWHITE">

    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'icons/apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'icons/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'icons/favicon-16x16.png' %}">

    {% block extra_css %}{% endblock %}
</head>

<body class="min-h-screen bg-gradient-to-br from-gray-950 via-gray-900 to-gray-950 text-gray-200 font-inter"
      x-data="{
        isMenuOpen: false,
        isMobile: window.innerWidth < 1024,
        init() {
            window.addEventListener('resize', () => { this.isMobile = window.innerWidth < 1024 })
        }
      }"
      :class="{ 'overflow-hidden': isMenuOpen && isMobile }"
      hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>

    <div id="pwa-install-banner"
         class="hidden fixed bottom-4 left-4 right-4 md:left-4 md:w-96 bg-gray-800/90 backdrop-blur-md text-white p-6 rounded-xl shadow-2xl z-50 border border-gray-700 transform transition-all duration-500 translate-y-20 opacity-0">
        <div class="flex items-center justify-between gap-4 flex-wrap">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-green-500/10 flex items-center justify-center shrink-0">
                    <i class="fas fa-download text-primary-green text-xl"></i>
                </div>
                <span class="font-medium text-sm">Installer l'application BWHITE ?</span>
            </div>
            <div class="flex gap-2 w-full justify-end mt-2">
                <button onclick="document.getElementById('pwa-install-banner').classList.add('hidden')"
                        class="px-4 py-2 text-sm text-gray-400 hover:text-white transition">
                    Plus tard
                </button>
                <button onclick="window.BWHITEUtils && window.BWHITEUtils.installPWA()"
                        class="bg-primary-green hover:bg-green-400 text-black px-4 py-2 rounded-lg font-bold text-sm transition shadow-lg shadow-green-500/20">
                    Installer
                </button>
            </div>
        </div>
    </div>

    <div id="offline-indicator" class="hidden fixed top-0 left-0 w-full bg-red-600 text-white text-center py-1 text-sm font-medium z-[60] shadow-lg">
        <i class="fas fa-wifi-slash mr-2"></i>Connexion internet perdue
    </div>

    {% block banner %}
        {% include "includes/_top_banner.html" %}
    {% endblock %}

    <nav class="sticky top-0 z-40 bg-gray-900/90 backdrop-blur-md border-b border-gray-800 shadow-sm">
        <div class="px-4 md:px-6 py-3">
            <div class="flex items-center justify-between">
                <a href="{% url 'dashboard:home' %}" class="flex items-center gap-3 group">
                    <div class="w-9 h-9 relative flex items-center justify-center">
                        <img src="{% static 'images/logo.png' %}" alt="Logo" id="nav-main-logo" class="w-full h-full object-contain transition group-hover:scale-110">
                        <div id="nav-fallback-icon" class="hidden absolute inset-0 bg-green-500/10 rounded-lg items-center justify-center">
                            <i class="fas fa-gem text-primary-green"></i>
                        </div>
                    </div>
                    <span class="text-lg font-bold tracking-tight text-white">
                        Bwhite <span class="text-primary-green">Digital</span>
                    </span>
                </a>

                {% if user.is_authenticated %}
                <div class="flex items-center gap-3">
                    <div class="hidden lg:flex items-center gap-3">
                        <a href="{% url 'contracts:nouveau_contrat' %}"
                           class="btn-primary-modern flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition text-sm font-medium shadow-lg shadow-blue-900/20">
                            <i class="fas fa-plus"></i> Nouveau Contrat
                        </a>
                        {% if user.role == 'ADMIN' %}
                        <a href="{% url 'accounts:nouveau_apporteur' %}"
                           class="flex items-center gap-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 text-green-400 border border-gray-700 rounded-lg transition text-sm font-medium">
                            <i class="fas fa-user-plus"></i> Apporteur
                        </a>
                        {% endif %}
                    </div>

                    <div x-data="{ open: false }" @click.outside="open = false" class="relative">
                        <button @click="open = !open"
                                class="flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-gray-800 transition border border-transparent hover:border-gray-700">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-green-500 to-blue-500 flex items-center justify-center text-white font-bold text-xs">
                                {{ user.username|make_list|first|upper }}
                            </div>
                            <span class="hidden sm:block text-sm font-medium text-gray-300">{{ user.username }}</span>
                            <i class="fas fa-chevron-down text-xs text-gray-500 transition-transform duration-200" :class="open ? 'rotate-180' : ''"></i>
                        </button>

                        <div x-show="open" x-cloak
                             x-transition:enter="transition ease-out duration-100"
                             x-transition:enter-start="transform opacity-0 scale-95"
                             x-transition:enter-end="transform opacity-100 scale-100"
                             class="absolute right-0 mt-2 w-48 bg-gray-800 rounded-xl shadow-2xl py-1 border border-gray-700 ring-1 ring-black ring-opacity-5">
                            <a href="{% url 'accounts:profile' %}" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white">
                                <i class="fas fa-user-circle mr-2 w-4"></i> Mon Profil
                            </a>
                            <div class="border-t border-gray-700 my-1"></div>
                            <form action="{% url 'accounts:logout' %}" method="post">
                                {% csrf_token %}
                                <button type="submit" class="w-full text-left block px-4 py-2 text-sm text-red-400 hover:bg-gray-700 hover:text-red-300">
                                    <i class="fas fa-sign-out-alt mr-2 w-4"></i> DÃ©connexion
                                </button>
                            </form>
                        </div>
                    </div>

                    <button @click="isMenuOpen = !isMenuOpen"
                            class="lg:hidden p-2 text-gray-400 hover:text-white rounded-lg hover:bg-gray-800 transition">
                        <i class="fas" :class="isMenuOpen ? 'fa-times' : 'fa-bars text-xl'"></i>
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        {% if messages %}
        <div class="absolute top-full left-0 w-full px-4 md:px-6">
            <div class="max-w-7xl mx-auto py-2 space-y-2">
                {% for message in messages %}
                <div x-data="{ show: true }" x-show="show" x-init="setTimeout(() => show = false, 5000)"
                     x-transition:leave="transition ease-in duration-300"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0"
                     class="flex items-center justify-between p-3 rounded-lg text-sm border shadow-lg
                     {% if 'success' in message.tags %} bg-green-900/90 border-green-700 text-green-100
                     {% elif 'error' in message.tags %} bg-red-900/90 border-red-700 text-red-100
                     {% else %} bg-gray-800 border-gray-600 text-gray-200 {% endif %}">
                    <div class="flex items-center gap-2">
                        {% if 'success' in message.tags %}<i class="fas fa-check-circle"></i>
                        {% elif 'error' in message.tags %}<i class="fas fa-exclamation-circle"></i>
                        {% else %}<i class="fas fa-info-circle"></i>{% endif %}
                        <span>{{ message }}</span>
                    </div>
                    <button @click="show = false" class="text-white/60 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </nav>

    <div class="flex min-h-[calc(100vh-64px)] relative">
        {% if user.is_authenticated %}
            <div x-show="isMenuOpen"
                 x-transition.opacity
                 @click="isMenuOpen = false"
                 class="mobile-menu-overlay lg:hidden" x-cloak></div>

            <aside :class="isMenuOpen ? 'translate-x-0 shadow-2xl' : '-translate-x-full'"
                   class="mobile-sidebar sidebar-transition bg-gray-900 border-r border-gray-800 lg:translate-x-0 lg:static lg:block fixed inset-y-0 left-0 z-40 w-64 overflow-y-auto">

                <div class="p-4 space-y-6">
                    <div class="lg:hidden space-y-3 pb-4 border-b border-gray-800">
                        <a href="{% url 'contracts:nouveau_contrat' %}"
                           class="block w-full text-center py-3 bg-blue-600 rounded-xl text-white font-bold shadow-lg shadow-blue-900/30">
                            <i class="fas fa-plus mr-2"></i> Nouveau Contrat
                        </a>
                        {% if user.role == 'ADMIN' %}
                        <a href="{% url 'accounts:nouveau_apporteur' %}"
                           class="block w-full text-center py-3 bg-gray-800 border border-gray-700 hover:bg-gray-700 rounded-xl text-green-400 font-bold shadow-lg transition">
                            <i class="fas fa-user-plus mr-2"></i> Ajouter Apporteur
                        </a>
                        {% endif %}
                    </div>

                    <ul class="space-y-1">
                        {% url 'dashboard:home' as dashboard_url %}
                        <li>
                            <a href="{{ dashboard_url }}"
                               class="flex items-center gap-3 px-4 py-3 rounded-xl transition duration-200
                               {% if request.path == dashboard_url %} bg-gray-800 text-primary-green font-semibold border-l-4 border-primary-green {% else %} text-gray-400 hover:bg-gray-800 hover:text-white {% endif %}">
                                <i class="fas fa-tachometer-alt w-5 text-center"></i><span>Tableau de bord</span>
                            </a>
                        </li>

                        {% url 'contracts:liste_contrats' as contrats_url %}
                        <li>
                            <a href="{{ contrats_url }}"
                               class="flex items-center gap-3 px-4 py-3 rounded-xl transition duration-200
                               {% if request.path|slice:':18' == '/contracts/contrats' %} bg-gray-800 text-primary-green font-semibold border-l-4 border-primary-green {% else %} text-gray-400 hover:bg-gray-800 hover:text-white {% endif %}">
                                <i class="fas fa-file-contract w-5 text-center"></i><span>Contrats</span>
                            </a>
                        </li>

                        {% url 'contracts:liste_clients' as clients_url %}
                        <li>
                            <a href="{{ clients_url }}"
                               class="flex items-center gap-3 px-4 py-3 rounded-xl transition duration-200
                               {% if request.path == clients_url %} bg-gray-800 text-primary-green font-semibold border-l-4 border-primary-green {% else %} text-gray-400 hover:bg-gray-800 hover:text-white {% endif %}">
                                <i class="fas fa-users w-5 text-center"></i><span>Clients</span>
                            </a>
                        </li>

                        {% if user.role == 'APPORTEUR' %}
                            {% url 'payments:mes_paiements' as paiements_url %}
                            <li>
                                <a href="{{ paiements_url }}"
                                   class="flex items-center gap-3 px-4 py-3 rounded-xl transition duration-200
                                   {% if request.path == paiements_url %} bg-gray-800 text-primary-green font-semibold border-l-4 border-primary-green {% else %} text-gray-400 hover:bg-gray-800 hover:text-white {% endif %}">
                                    <i class="fas fa-wallet w-5 text-center"></i><span>Mes Commissions</span>
                                </a>
                            </li>
                        {% endif %}

                        {% if user.is_staff %}
                            <li class="pt-4 mt-4 border-t border-gray-800">
                                <p class="px-4 text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Administration</p>
                            </li>

                            {% url 'accounts:liste_apporteurs' as apporteurs_url %}
                            <li>
                                <a href="{{ apporteurs_url }}"
                                   class="flex items-center gap-3 px-4 py-3 rounded-xl transition duration-200
                                   {% if request.path == apporteurs_url %} bg-gray-800 text-primary-green font-semibold border-l-4 border-primary-green {% else %} text-gray-400 hover:bg-gray-800 hover:text-white {% endif %}">
                                    <i class="fas fa-user-tie w-5 text-center"></i><span>Apporteurs</span>
                                </a>
                            </li>

                            {% url 'payments:liste_encaissements' as encaissements_url %}
                            <li>
                                <a href="{{ encaissements_url }}"
                                   class="flex items-center gap-3 px-4 py-3 rounded-xl transition duration-200
                                   {% if request.path == encaissements_url %} bg-gray-800 text-primary-green font-semibold border-l-4 border-primary-green {% else %} text-gray-400 hover:bg-gray-800 hover:text-white {% endif %}">
                                    <i class="fas fa-money-bill-wave w-5 text-center"></i><span>Finances</span>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            </aside>
        {% endif %}

        <main class="flex-1 w-full overflow-hidden">
            {% block content %}{% endblock %}
        </main>
    </div>

    <div id="global-spinner" aria-live="polite" aria-busy="true"
         class="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center backdrop-blur-sm htmx-indicator"
         style="display: none;">
        <div class="flex flex-col items-center gap-3">
            <div class="w-14 h-14 rounded-full border-4 border-primary-green/30 border-t-primary-green animate-spin"></div>
            <p class="text-sm text-gray-100">Traitement en cours...</p>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script defer src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
    <script defer src="{% static 'js/app.js' %}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Logo fallback
            const logo = document.getElementById('nav-main-logo');
            const fallback = document.getElementById('nav-fallback-icon');
            if (logo && fallback) {
                logo.onerror = function() {
                    this.style.display = 'none';
                    fallback.classList.remove('hidden');
                    fallback.classList.add('flex');
                };
            }

            // Spinner HTMX (safe)
            const spinner = document.getElementById('global-spinner');
            if (spinner) {
                document.body.addEventListener('htmx:beforeRequest', function() {
                    spinner.style.display = 'flex';
                });
                document.body.addEventListener('htmx:afterRequest', function() {
                    spinner.style.display = 'none';
                });
                document.body.addEventListener('htmx:error', function() {
                    spinner.style.display = 'none';
                });
            }
        });

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register("{% url 'sw.js' %}")
                .catch(err => console.error('SW Error:', err));
        }

        // Offline detection
        window.addEventListener('online', () => document.getElementById('offline-indicator')?.classList.add('hidden'));
        window.addEventListener('offline', () => document.getElementById('offline-indicator')?.classList.remove('hidden'));
        if (!navigator.onLine) document.getElementById('offline-indicator')?.classList.remove('hidden');

        // PWA Install Logic
        let deferredPrompt;
        const banner = document.getElementById('pwa-install-banner');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            {% if user.is_authenticated %}
            if (banner) {
                banner.classList.remove('hidden');
                setTimeout(() => {
                    banner.classList.remove('translate-y-20', 'opacity-0');
                }, 100);
            }
            {% endif %}
        });

        window.BWHITEUtils = {
            installPWA: async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    await deferredPrompt.userChoice;
                    deferredPrompt = null;
                    if (banner) banner.classList.add('hidden');
                }
            }
        };
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
