{% extends 'base.html' %}
{% load humanize %}

{% block title %}Encaissements apporteurs{% endblock %}

{% block content %}
    <div class="max-w-7xl mx-auto px-4 py-8 space-y-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <h1 class="text-3xl font-bold text-white flex items-center gap-3">
                <i class="fas fa-money-check-alt text-primary-green"></i>
                <span>Encaissements apporteurs</span>
            </h1>
        </div>

        <div class="bg-gray-900 rounded-xl border border-gray-800 p-4">
            <form method="get" class="flex flex-col md:flex-row flex-wrap gap-3">
                <select name="status"
                        class="px-4 py-2 bg-gray-900 text-white rounded-lg border border-gray-700 focus:border-primary-green focus:ring-1 focus:ring-primary-green focus:outline-none transition-colors">
                    <option value="">Tous les statuts</option>
                    <option value="EN_ATTENTE" {% if filter_status == "EN_ATTENTE" %}selected{% endif %}>En attente</option>
                    <option value="PAYE" {% if filter_status == "PAYE" %}selected{% endif %}>Payés</option>
                    <option value="ANNULE" {% if filter_status == "ANNULE" %}selected{% endif %}>Annulés</option>
                </select>

                <input type="text"
                       name="q"
                       value="{{ query }}"
                       placeholder="Police, réf. ou client"
                       class="px-4 py-2 bg-gray-900 text-white rounded-lg border border-gray-700 focus:border-primary-green focus:ring-1 focus:ring-primary-green focus:outline-none transition-colors">

                <input type="number"
                       name="apporteur"
                       value="{{ apporteur_id }}"
                       placeholder="ID apporteur"
                       class="px-4 py-2 bg-gray-900 text-white rounded-lg border border-gray-700 focus:border-primary-green focus:ring-1 focus:ring-primary-green focus:outline-none transition-colors">

                <button type="submit" class="px-4 py-2 rounded-lg bg-primary-green text-black font-semibold hover:bg-green-400 transition flex items-center gap-2">
                    <i class="fas fa-filter"></i><span>Filtrer</span>
                </button>

                {% if filter_status or query or apporteur_id %}
                    <a href="{% url 'payments:liste_encaissements' %}"
                       class="px-4 py-2 rounded-lg bg-red-900/50 text-red-200 border border-red-800 hover:bg-red-900 transition flex items-center gap-2">
                        <i class="fas fa-times"></i><span>Réinitialiser</span>
                    </a>
                {% endif %}
            </form>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
                <p class="text-sm text-gray-400 mb-2">Total éléments</p>
                <p class="text-3xl font-bold text-white">{{ page_obj.paginator.count|default:0 }}</p>
            </div>
            <div class="bg-gray-900 rounded-xl p-6 border border-yellow-800/50">
                <div class="flex items-center justify-between mb-1">
                    <p class="text-sm text-gray-400">Montant en attente</p>
                    <i class="fas fa-clock text-yellow-400 text-xl"></i>
                </div>
                <p class="text-2xl font-bold text-yellow-400">{{ total_attente|default_if_none:0|floatformat:0|intcomma }} F</p>
            </div>
            <div class="bg-gray-900 rounded-xl p-6 border border-green-800/50">
                <div class="flex items-center justify-between mb-1">
                    <p class="text-sm text-gray-400">Montant payé</p>
                    <i class="fas fa-check-circle text-green-400 text-xl"></i>
                </div>
                <p class="text-2xl font-bold text-green-400">{{ total_paye|default_if_none:0|floatformat:0|intcomma }} F</p>
            </div>
        </div>

        <div class="bg-gray-900 rounded-xl border border-gray-800 shadow-lg overflow-x-auto">
            <div class="p-6 border-b border-gray-800">
                <h2 class="text-xl font-semibold text-white flex items-center gap-2">
                    <i class="fas fa-list text-primary-green"></i>
                    Liste détaillée
                </h2>
            </div>
            <table class="w-full text-sm">
                <thead class="bg-gray-950/50 border-b border-gray-700">
                    <tr>
                        <th class="px-4 py-3 text-left text-gray-400 font-medium">Police</th>
                        <th class="px-4 py-3 text-left text-gray-400 font-medium">Client</th>
                        <th class="px-4 py-3 text-left text-gray-400 font-medium">Apporteur</th>
                        <th class="px-4 py-3 text-right text-gray-400 font-medium">À payer</th>
                        <th class="px-4 py-3 text-right text-gray-400 font-medium">Payé</th>
                        <th class="px-4 py-3 text-center text-gray-400 font-medium">Statut</th>
                        <th class="px-4 py-3 text-left text-gray-400 font-medium">Moyen / Réf.</th>
                        <th class="px-4 py-3 text-left text-gray-400 font-medium">Maj</th>
                        <th class="px-4 py-3 text-center text-gray-400 font-medium">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-800">
                    {% for p in paiements %}
                        <tr class="hover:bg-gray-800/60 transition group">
                            <td class="px-4 py-3">
                                <a href="{% url 'contracts:detail_contrat' p.contrat.pk %}"
                                   class="text-white font-medium hover:text-primary-green transition">
                                    {{ p.contrat.numero_police|default:"SIMULATION" }}
                                </a>
                            </td>
                            <td class="px-4 py-3 text-gray-300">
                                {{ p.contrat.client.nom_complet }}
                            </td>
                            <td class="px-4 py-3 text-gray-300">
                                {{ p.contrat.apporteur.get_full_name }}
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="text-blue-400 font-semibold">{{ p.montant_a_payer|default_if_none:0|floatformat:0|intcomma }} F</span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="text-green-400 font-semibold">
                                    {% if p.status == "PAYE" %}
                                        {{ p.montant_a_payer|default_if_none:0|floatformat:0|intcomma }} F
                                    {% else %}
                                        0 F
                                    {% endif %}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                {% if p.status == "PAYE" %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-500/10 text-green-400 border border-green-500/40">
                                        <i class="fas fa-check-circle mr-1"></i> Payé
                                    </span>
                                {% elif p.status == "EN_ATTENTE" %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-yellow-500/10 text-yellow-400 border border-yellow-500/40">
                                        <i class="fas fa-clock mr-1"></i> En attente
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-red-500/10 text-red-400 border border-red-500/40">
                                        <i class="fas fa-ban mr-1"></i> Annulé
                                    </span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-gray-400 text-xs">
                                <div class="truncate max-w-[150px]" title="{{ p.reference_transaction }}">
                                    {{ p.methode_paiement|default:"-" }}
                                    {% if p.reference_transaction %}
                                        <span class="block text-gray-500">{{ p.reference_transaction }}</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-4 py-3 text-gray-500 text-xs">
                                {{ p.updated_at|date:"d/m/Y H:i" }}
                            </td>
                            <td class="px-4 py-3 text-center">
                                <a href="{% url 'payments:detail_encaissement' p.id %}"
                                   class="text-gray-400 hover:text-white transition p-2 bg-gray-800 rounded-lg hover:bg-gray-700"
                                   title="Voir le détail">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="9" class="text-center py-12 text-gray-500">
                                <div class="flex flex-col items-center justify-center gap-2">
                                    <i class="fas fa-inbox text-4xl mb-2 text-gray-700"></i>
                                    <p class="text-lg font-medium">Aucun encaissement trouvé</p>
                                    <p class="text-sm">Essayez de modifier vos filtres</p>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if page_obj.has_other_pages %}
            <div class="flex items-center justify-center gap-3 pt-4">
                {% if page_obj.has_previous %}
                    <a class="px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white text-sm hover:bg-gray-700 transition"
                       href="?page={{ page_obj.previous_page_number }}{% if filter_status %}&status={{ filter_status }}{% endif %}{% if apporteur_id %}&apporteur={{ apporteur_id }}{% endif %}{% if query %}&q={{ query }}{% endif %}">
                        <i class="fas fa-chevron-left mr-1"></i> Précédent
                    </a>
                {% endif %}

                <span class="px-4 py-2 text-gray-400 text-sm font-medium bg-gray-900 rounded-lg border border-gray-800">
                    Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                </span>

                {% if page_obj.has_next %}
                    <a class="px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white text-sm hover:bg-gray-700 transition"
                       href="?page={{ page_obj.next_page_number }}{% if filter_status %}&status={{ filter_status }}{% endif %}{% if apporteur_id %}&apporteur={{ apporteur_id }}{% endif %}{% if query %}&q={{ query }}{% endif %}">
                        Suivant <i class="fas fa-chevron-right ml-1"></i>
                    </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
{% endblock %}