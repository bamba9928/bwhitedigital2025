{% extends "base.html" %}
{% load humanize %}

{% block title %}Détail encaissement{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8 space-y-6">
    <h1 class="text-2xl font-bold text-white flex items-center gap-3">
        <i class="fas fa-file-invoice-dollar text-primary-green"></i>
        <span>Détail encaissement</span>
    </h1>

    <!-- Bloc principal -->
    <div class="bg-gray-900 rounded-xl border border-gray-800 p-6 space-y-6">
        <div class="grid md:grid-cols-2 gap-5 text-sm">
            <div>
                <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Contrat</p>
                <p class="text-white font-semibold">
                    {{ paiement.contrat.numero_police|default:"SIMULATION" }}
                </p>
                <p class="text-gray-400 text-xs mt-1">
                    Créé le {{ paiement.contrat.created_at|date:"d/m/Y H:i" }}
                </p>
            </div>
            <div>
                <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Client</p>
                <p class="text-white font-semibold">
                    {{ paiement.contrat.client.nom_complet }}
                </p>
                <p class="text-gray-400 text-xs mt-1">
                    {{ paiement.contrat.client.telephone }}
                </p>
            </div>
            <div>
                <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Apporteur</p>
                <p class="text-white font-semibold">
                    {{ paiement.contrat.apporteur.get_full_name }}
                </p>
                <p class="text-gray-400 text-xs mt-1">
                    {{ paiement.contrat.apporteur.email }}
                </p>
            </div>
            <div>
                <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Montants</p>
                <p class="text-gray-300">
                    Prime TTC :
                    <span class="text-green-400 font-semibold">
                        {{ paiement.contrat.prime_ttc|floatformat:0|intcomma }} F
                    </span>
                </p>
                <p class="text-gray-300">
                    Net à reverser / dû :
                    <span class="text-blue-400 font-semibold">
                        {{ paiement.montant_a_payer|floatformat:0|intcomma }} F
                    </span>
                </p>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-5 text-sm">
            <div>
                <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Statut encaissement</p>
                <div class="flex items-center gap-2">
                    {% if paiement.status == "PAYE" %}
                        <span class="px-2 py-1 rounded-full text-xs bg-green-500/10 text-green-400 border border-green-500/40">
                            Payé
                        </span>
                    {% elif paiement.status == "EN_ATTENTE" %}
                        <span class="px-2 py-1 rounded-full text-xs bg-yellow-500/10 text-yellow-400 border border-yellow-500/40">
                            En attente
                        </span>
                    {% else %}
                        <span class="px-2 py-1 rounded-full text-xs bg-red-500/10 text-red-400 border border-red-500/40">
                            Annulé
                        </span>
                    {% endif %}
                    <span class="text-gray-400 text-xs">
                        Mis à jour le {{ paiement.updated_at|date:"d/m/Y H:i" }}
                    </span>
                </div>
            </div>
            <div>
                <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Montant payé</p>
                <p class="text-green-400 font-bold text-base">
                    {{ paiement.montant_paye|floatformat:0|intcomma }} F
                </p>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-5 text-sm">
            <div>
                <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Méthode de paiement</p>
                <p class="text-gray-100">
                    {{ paiement.methode_paiement|default:"-" }}
                </p>
            </div>
            <div>
                <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Référence transaction</p>
                <p class="text-gray-100">
                    {{ paiement.reference_transaction|default:"-" }}
                </p>
            </div>
            <div>
                <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">N° compte / Wallet</p>
                <p class="text-gray-100">
                    {{ paiement.numero_compte|default:"-" }}
                </p>
            </div>
            <div>
                <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Notes</p>
                <p class="text-gray-100">
                    {{ paiement.notes|default:"-" }}
                </p>
            </div>
        </div>
    </div>

    <!-- Historique -->
    <div class="bg-gray-900 rounded-xl border border-gray-800 p-5 space-y-3">
        <h2 class="text-lg font-semibold text-white flex items-center gap-2">
            <i class="fas fa-history text-primary-green"></i>
            Historique des actions
        </h2>
        <div class="divide-y divide-gray-800">
            {% for h in paiement.historiques.all %}
                <div class="py-3 text-sm flex items-start justify-between gap-4">
                    <div>
                        <p class="text-gray-200">
                            <span class="font-semibold">{{ h.get_action_display }}</span>
                            {% if h.effectue_par %}
                                · <span class="text-gray-300">{{ h.effectue_par.get_full_name }}</span>
                            {% else %}
                                · <span class="text-gray-500 italic">Système / API</span>
                            {% endif %}
                        </p>
                        {% if h.details %}
                            <p class="text-gray-400 text-xs mt-1">{{ h.details }}</p>
                        {% endif %}
                    </div>
                    <div class="text-xs text-gray-500 whitespace-nowrap">
                        {{ h.created_at|date:"d/m/Y H:i" }}
                    </div>
                </div>
            {% empty %}
                <p class="text-gray-500 text-sm py-2">
                    Aucun historique enregistré pour cet encaissement.
                </p>
            {% endfor %}
        </div>
    </div>

    <!-- Validation manuelle staff -->
    {% if paiement.est_en_attente and user.is_staff %}
        <div class="bg-gray-900 rounded-xl border border-gray-800 p-5 space-y-4 form-dark-theme">
            <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                <i class="fas fa-check-circle text-primary-green"></i>
                Validation manuelle du paiement
            </h2>
            <p class="text-sm text-gray-400">
                À utiliser uniquement en cas de régularisation manuelle (paiement confirmé hors Bictorys).
            </p>

            <form method="post" action="{% url 'payments:valider_encaissement' paiement.id %}">
                {% csrf_token %}
                <div class="grid md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1.5">
                            Méthode de paiement
                        </label>
                        {{ vform.methode_paiement }}
                        {% if vform.methode_paiement.errors %}
                            <p class="text-red-400 text-xs mt-1">
                                {{ vform.methode_paiement.errors.0 }}
                            </p>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1.5">
                            Référence transaction
                        </label>
                        {{ vform.reference_transaction }}
                        {% if vform.reference_transaction.errors %}
                            <p class="text-red-400 text-xs mt-1">
                                {{ vform.reference_transaction.errors.0 }}
                            </p>
                        {% endif %}
                    </div>
                </div>

                <div class="flex items-center justify-end gap-3 pt-4">
                    <a href="{% url 'payments:liste_encaissements' %}"
                       class="px-4 py-2 rounded-lg border border-gray-700 text-gray-300 hover:bg-gray-800 hover:text-white transition-colors text-sm font-medium">
                        Annuler
                    </a>
                    <button type="submit"
                            class="px-5 py-2 rounded-lg bg-green-600 text-white font-bold hover:bg-green-500 shadow-lg shadow-green-900/20 transition-all transform hover:-translate-y-0.5 flex items-center gap-2 text-sm">
                        <i class="fas fa-check-circle"></i>
                        Valider le paiement
                    </button>
                </div>
            </form>
        </div>
    {% endif %}
</div>
{% endblock %}
