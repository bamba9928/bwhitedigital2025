{% extends "base.html" %}
{% load humanize %}
{% block title %}Détail encaissement{% endblock %}

{% block content %}
    <style>
        /* Cibler les inputs et selects générés par Django dans ce formulaire */
        .form-dark-theme select,
        .form-dark-theme input[type="text"],
        .form-dark-theme input[type="number"] {
            width: 100%;
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
            color: #e5e7eb; /* text-gray-200 */
            padding: 0.625rem 0.75rem; /* p-2.5 */
            border-radius: 0.5rem; /* rounded-lg */
            font-size: 0.875rem; /* text-sm */
            outline: none;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        /* Focus state (vert comme le projet) */
        .form-dark-theme select:focus,
        .form-dark-theme input:focus {
            border-color: #16a34a; /* green-600 */
            box-shadow: 0 0 0 1px #16a34a;
        }

        /* Pour le placeholder si nécessaire */
        .form-dark-theme ::placeholder {
            color: #9ca3af; /* gray-400 */
        }
    </style>

    <div class="max-w-4xl mx-auto px-4 py-8 space-y-6">
        <div class="flex items-center justify-between">
            <h1 class="text-2xl font-bold text-white flex items-center gap-3">
                <i class="fas fa-eye text-primary-green"></i>
                Détail encaissement
            </h1>
            <a href="{% url 'payments:liste_encaissements' %}"
               class="px-3 py-2 rounded-lg border border-gray-700 text-gray-200 hover:bg-gray-800 text-sm">Retour</a>
        </div>

        <div class="bg-gray-900 rounded-xl border border-gray-800 p-5 shadow-lg">
            <div class="grid md:grid-cols-3 gap-4 text-sm">
                <div>
                    <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Police</p>
                    <p class="text-white font-semibold">
                        <a class="text-blue-400 hover:text-blue-300 transition-colors"
                           href="{% url 'contracts:detail_contrat' paiement.contrat.pk %}">
                            {{ paiement.contrat.numero_police|default:"-" }}
                        </a>
                    </p>
                </div>
                <div>
                    <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Client</p>
                    <p class="text-white font-semibold">{{ paiement.contrat.client.nom_complet }}</p>
                </div>
                <div>
                    <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Apporteur</p>
                    <p class="text-white font-semibold">{{ paiement.contrat.apporteur.get_full_name }}</p>
                </div>
                <div>
                    <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">À payer</p>
                    <p class="text-blue-400 font-bold text-base">{{ paiement.montant_a_payer|floatformat:0|intcomma }} F</p>
                </div>
                <div>
                    <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Payé</p>
                    <p class="text-green-400 font-bold text-base">{{ paiement.montant_paye|floatformat:0|intcomma }} F</p>
                </div>
                <div>
                    <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Statut</p>
                    {% if paiement.est_paye %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-900/60 text-green-400 border border-green-800">
                            <span class="w-1.5 h-1.5 mr-1.5 bg-green-400 rounded-full"></span> PAYÉ
                        </span>
                    {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-900/60 text-yellow-400 border border-yellow-800">
                            <span class="w-1.5 h-1.5 mr-1.5 bg-yellow-400 rounded-full animate-pulse"></span> EN ATTENTE
                        </span>
                    {% endif %}
                </div>

                <div class="col-span-full h-px bg-gray-800 my-2"></div>

                <div class="md:col-span-3 grid md:grid-cols-3 gap-4">
                    <div>
                        <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Méthode</p>
                        <p class="text-gray-200">{{ paiement.get_methode_paiement_display|default:"-" }}</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Référence</p>
                        <p class="text-gray-200 break-all font-mono text-xs bg-gray-800/50 p-1 rounded inline-block">
                            {{ paiement.reference_transaction|default:"Aucune référence" }}
                        </p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Dernière maj</p>
                        <p class="text-gray-200">{{ paiement.updated_at|date:"d/m/Y H:i" }}</p>
                    </div>
                </div>
                {% if paiement.notes %}
                    <div class="md:col-span-3 mt-2">
                        <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">Notes</p>
                        <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700/50">
                            <p class="text-gray-300 whitespace-pre-line text-sm italic">{{ paiement.notes }}</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="bg-gray-900 rounded-xl border border-gray-800 p-6 shadow-lg">
            {% if paiement.est_paye %}
                <div class="flex flex-col items-center justify-center py-6 text-center space-y-3">
                    <div class="w-12 h-12 rounded-full bg-green-900/30 flex items-center justify-center mb-2">
                        <i class="fas fa-check text-2xl text-green-500"></i>
                    </div>
                    <h3 class="text-lg font-medium text-white">Paiement validé</h3>
                    <p class="text-gray-400 max-w-md">Ce paiement a déjà été traité et validé. Aucune action supplémentaire n'est requise.</p>
                </div>
            {% else %}
                <div class="mb-5">
                    <h3 class="text-lg font-medium text-white">Validation du paiement</h3>
                    <p class="text-gray-400 text-sm">Veuillez renseigner les détails de la transaction pour valider l'encaissement.</p>
                </div>

                <form method="post"
                      action="{% url 'payments:valider_encaissement' paiement.id %}"
                      class="space-y-5 form-dark-theme"> {% csrf_token %}

                    {% if vform.non_field_errors %}
                        <div class="p-3 rounded-lg bg-red-900/30 border border-red-800 text-red-300 text-sm flex items-start gap-2">
                            <i class="fas fa-exclamation-circle mt-0.5"></i>
                            <div>{{ vform.non_field_errors }}</div>
                        </div>
                    {% endif %}

                    <div class="grid md:grid-cols-2 gap-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1.5">
                                Méthode de paiement <span class="text-red-400">*</span>
                            </label>
                            {{ vform.methode_paiement }}
                            {% if vform.methode_paiement.errors %}
                                <p class="text-red-400 text-xs mt-1 pl-1">{{ vform.methode_paiement.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1.5">
                                Référence transaction <span class="text-red-400">*</span>
                            </label>
                            {{ vform.reference_transaction }}
                            {% if vform.reference_transaction.errors %}
                                <p class="text-red-400 text-xs mt-1 pl-1">{{ vform.reference_transaction.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="pt-4 border-t border-gray-800 flex items-center justify-end gap-3">
                        <a href="{% url 'payments:liste_encaissements' %}"
                           class="px-4 py-2 rounded-lg border border-gray-600 text-gray-300 hover:bg-gray-700 hover:text-white transition-colors text-sm font-medium">
                            Annuler
                        </a>
                        <button type="submit"
                                class="px-5 py-2 rounded-lg bg-green-600 text-white font-medium hover:bg-green-500 shadow-lg shadow-green-900/20 transition-all transform hover:-translate-y-0.5 flex items-center gap-2">
                            <i class="fas fa-check-circle"></i>
                            Valider le paiement
                        </button>
                    </div>
                </form>
            {% endif %}
        </div>
    </div>
{% endblock %}